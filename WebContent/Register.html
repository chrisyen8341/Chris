<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=BIG5">

<!-- 避免favicon.ico請求 -->
<link rel="shortcut icon" href="">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script>

	$(function() {

		//針對下面的七項特別驗證各自設標籤  因為每項不能為空值  故使用者ㄧ定會填 並促發下面七項blur驗證
		//個別驗證為錯即為false
		//最後在表單送出時會對這七項驗證判別 只要有ㄧ個為false  停止送出表單
		var valids = new Array(true,true, true,true,true,true,true);

		//帳號驗證 AJAX確認帳號是否存在
		$("#memId").blur(function () {
							var xmlhttp = new XMLHttpRequest();
							var memid = $("#memId").val();
							var url = "exist.jsp?memid=" + memid;
							xmlhttp.onreadystatechange = function() {
									if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
									if (xmlhttp.responseText.trim() == "帳號長度需大於6"
										||xmlhttp.responseText.trim() == "帳號需含英文字"
										||xmlhttp.responseText.trim() == "很抱歉,帳號已存在")
										{
									$("#memIdShow").css('color','red');
									valids[0]=false;
									$("#memIdShow").html(xmlhttp.responseText);
								}
									else{
										$("#memIdShow").css('color','green');
									$("#memIdShow").html(xmlhttp.responseText);
									valids[0]=true;
								}
								}
							};
							try {
								xmlhttp.open("GET", url, true);
								xmlhttp.send();
								console.log("有走進來3");
							} catch (e) {
								alert("unable to connect to server");
							}
						});
		

		//密碼驗證 至少包含一個英文字
		$("#pwd").blur(function () {
			var regex = new RegExp('.*[a-zA-Z]+.*');
			if($("#pwd").val().length<6){
				$("#pwdShow").css('color','red');
				$("#pwdShow").html("密碼長度需大於6");
				valids[1]=false;
			}
			else if(!$("#pwd").val().match(regex)) {
				$("#pwdShow").css('color','red');
				$("#pwdShow").html("密碼須包含英文字");
				valids[1]=false;
			} 
			else{
				$("#pwdShow").css('color','green');
				$("#pwdShow").html("合格的密碼");
				valids[1]=true;
			}
		});

		//確認密碼驗證
		$("#checkpwd").blur(function() {
			if ($("#pwd").val().trim() == $("#checkpwd").val().trim()) {
				$("#pwdCheck").css('color','green');
				$("#pwdCheck").html("密碼相符");
				valids[2]=true;
			} else {
				$("#pwdCheck").css('color','red');
				$("#pwdCheck").html("密碼不相符");
				valids[2]=false;
			}
			;
		});



 //身分證驗證
	$("#idcard").blur(function (){
		var toBeTest=document.getElementById("idcard").value;
		isIdNo(toBeTest);
		});


	function isIdNo(id){
		valid = false;
		var re = new RegExp("[A-Z]{1}[1-2]{1}[0-9]{8}");
		if (re.test(id)) {
			ids = id.split("");
			var test=0;
			var z = createCityNum2(ids[0]);
			for (var i = 1; i < 9; i++) {
				test = test + parseInt(ids[i]) * (9 - i);
			}
			var remainder=((test +(Math.floor(z / 10) + (z%10)*9))%10);
			(remainder==0)? (test=0) : (test=10-remainder);
			if (test == parseInt(ids[9])) {
				valid = true;
			}
		};
		if(!valid){
					$("#idShow").css('color','red');
					$("#idShow").html("不合格的身分證");
					valids[3]=false;
		}
		else{
					$("#idShow").css('color','green');
					$("#idShow").html("合格的身分證");
					valids[3]=true;
		}
	};

	function createCityNum2(c){
		var chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
		var nums=[10,11,12,13,14,15,16,17,34,18,19,20,21,22,35,23,24,25,26,27,28,29,32,30,31,33];
		return nums[chars.indexOf(c)];
	};

//生日最大可選天數
var today = new Date();
var dd = today.getDate();
var mm = today.getMonth()+1; //January is 0!
var yyyy = today.getFullYear();
 if(dd<10){
        dd='0'+dd
    } 
    if(mm<10){
        mm='0'+mm
    } 

today = yyyy+'-'+mm+'-'+dd;
document.getElementById("datefield1").setAttribute("max", today);
document.getElementById("datefield2").setAttribute("max", today);
		

		//生日驗證 生日不可以大於今天
		$("#datefield1,#datefield2").blur(function(e){
			console.log(e.target.id);
			var nDay=yyyy+mm+dd;
			if(e.target.id=="datefield1"){
			days=$("#datefield1").val().split("-");
			tDay=days[0]+days[1]+days[2];
			if(tDay>nDay){
					$("#birthShow").css('color','red');
					$("#birthShow").html("不合格的生日");
					valids[4]=false;
			}
			else{
				$("#birthShow").html("");
				valids[4]=true;
			}
		}
		else{
			days=$("#datefield2").val().split("-");
			tDay=days[0]+days[1]+days[2];
			if(tDay>nDay){
					$("#birthShow2").css('color','red');
					$("#birthShow2").html("不合格的生日");
					valids[5]=false;
			}
			else{
				$("#birthShow2").html("");
				valids[5]=true;
			}
		}

		});


		//信箱驗證
		$("#email").blur(function() {
			 if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test($("#email").val()))  
			  {  
					$("#emailShow").css('color','green');
					$("#emailShow").html("合格的EMAIL");
					valids[6]=true;
			  }  
				else{
					$("#emailShow").css('color','red');
					$("#emailShow").html("不合格的EMAIL");
					valids[6]=false;
				} 
		});


		//照片上傳預覽
		$("#mempic,#petPic").change(function() {
			readURL(this);
		});

		function readURL(input) {

			if (input.files && input.files[0]) {
				var reader = new FileReader();
				reader.onload = function(e) {
					//判斷input來源
					if(input.id=="mempic"){
					$('#mpic').attr('src', e.target.result);
				}
					else
					 $('#petPic2').attr('src', e.target.result);
				}
				reader.readAsDataURL(input.files[0]);
			}
		}


		//檢驗是否有養寵物
		$("input[name=petOrNot]").change(function(){
			if($('input[name=petOrNot]').get(1).checked){
				$("#petDiv").css("display","block");
			}
			else
				$("#petDiv").css("display","none");
		});


		//送出表單時檢察有無未填
		$('form').submit(function() {
			
			//預設是全部都填  
			var isEmpty = null;
			//只要input有沒填的 就改變為true
			if($('input[name=petOrNot]').get(0).checked)
			{
			console.log("1111111111111111")
			$("input").slice(0,12).each(function() {
				if ($.trim($(this).val()) === "") {
					alert('Text-field is empty.');
					isEmpty = true;
				}
			});
		}
			else{
				$("input").each(function() {
				if ($.trim($(this).val()) === "") {
					alert('Text-field is empty.');
					isEmpty = true;
				}
			});
			};

			//只要有空 就讓submit送不出去
			if (isEmpty) {
				return false;
			}


			for (var i = 0; i < valids.length; i++) {
    			if(!valids[i]){
    				return false;
    			}
    			console.log(i+" : "+valids[i]);
			}

		});

	});
</script>


<title>Insert title here</title>
</head>

<body>
	<form action="Register" method="post" enctype="multipart/form-data">

		<p>
			帳號: <br> <INPUT TYPE="TEXT" NAME="memId" id="memId"><span id="memIdShow"></span> <br>
			<p><font size="1">帳號須包含英文字且長度大於6</font></p>
		</p>

		<p>
			密碼: <br> <INPUT TYPE="password" NAME="memPwd" id="pwd"><span id="pwdShow"></span> <br>
			<p><font size="1">密碼須包含英文字且長度大於6</font></p>
		</p>

		<p>
			確認密碼: <br> <INPUT TYPE="password" NAME="conpwd" id="checkpwd"><span id="pwdCheck"></span> <br>
		</p>


		<p>
			姓名: <br> <INPUT TYPE="TEXT" NAME="memName" id="name"> <br>
		</p>
		
		<p>
			暱稱: <br> <INPUT TYPE="TEXT" NAME="memSname" id="memSname"> <br>
		</p>

		<p>
			身分證字號: <br> <INPUT TYPE="text" NAME="memIdNo" id="idcard"><span id="idShow"></span> <br>
		</p>

		<p>
			性別: <br>  
			<input type="radio" name="memGender" value="男" checked>男 
			<input type="radio" name="memGender" value="女"> 女 
			<input type="radio" name="memGender" value="其他">其他
		</p>

		<p>
		生日:<br>
		<input type="date" name="memBday" min="1910-01-01"  max='2000-13-13' id="datefield1"><span id="birthShow"></span>
		</p>

		<p>
			手機: <br> <INPUT TYPE="text" NAME="memPhone"> <br>
		</p>

		<p>
			地址: <br> <INPUT TYPE="text" NAME="memAddress"> <br>
		</p>

		<p>
			電子信箱: <br> <INPUT TYPE="text" NAME="memEmail" id="email"><span id="emailShow"></span> <br>
		</p>

		<p>
			照片: <br> <INPUT TYPE="file" NAME="memImg" id="mempic"> <br>
			<img src="images/default.jpg" id="mpic" width="150px" height="200px">
		</p>

		<p>
			有無養寵物: <br> 
			<input type="radio" name="petOrNot" value="0" id="no" checked>無
			<input type="radio" name="petOrNot" value="1" id="yes">有
		</p>
		
		<div id="petDiv" style="display:none;">

		<p>
			寵物姓名: <br> <INPUT TYPE="TEXT" NAME="petName" id="name"> <br>
		</p>
		<p>
		
		<p>
			寵物分類: <br> 
			<input type="radio" name="petKind" value="狗" checked>狗
			<input type="radio" name="petKind" value="貓">貓
			<input type="radio" name="petKind" value="其他">其他
		</p>

		<p>
			寵物性別: <br> 
			<input type="radio" name="petGender" value="男" checked>男
			<input type="radio" name="petGender" value="女">女
			<input type="radio" name="petGender" value="其他">中性
		</p>

		<p>
			寵物品種: <br> <INPUT TYPE="TEXT" NAME="petSpecies" id="petSpecies"> 
			<br>
		</p>


		<p>
		寵物生日: <br>
		<input type="date" name="petBday" min="1910-01-01" max='2000-13-13' id="datefield2"><span id="birthShow2"></span><br><br>
		</p>

		<p>
			寵物照片: <br> <INPUT TYPE="file" NAME="petImg" id="petPic"> <br>
			<img src="images/default.jpg" id="petPic2" width="150px" height="200px">
		</p>

		</div>


		<h3>
		剩下的小BUG
		<br>1.如果開了寵物 日期填錯 再把寵物關掉會送不出去
		<br>2.trim();
		<br>3.slice()有沒抓準不確定;
		</h3>
		<input type="submit" value="註冊">
	</form>
</body>
</html>